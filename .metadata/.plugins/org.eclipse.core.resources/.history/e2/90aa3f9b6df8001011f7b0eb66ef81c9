package com.bazotech.store.domain;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import jakarta.persistence.CascadeType;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.JoinTable;
import jakarta.persistence.ManyToMany;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToMany;
import jakarta.persistence.PrePersist;
import jakarta.persistence.Table;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;


@Getter
@Setter
@ToString(exclude= {"products","storeItems","tags"})
@EqualsAndHashCode(onlyExplicitlyIncluded = true)
@Table(name="inventory_items")
@Entity
public class InventoryItem {
	
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	
	@Column(name="item_id", nullable=false)
	private Long itemId;
	@EqualsAndHashCode.Include /* using only the itemId for equality */
	@NotNull
	@ManyToOne(optional=false) 
	@JoinColumn(name="merchant_id", nullable=false) 
	private Merchant merchant; 
	
	@ManyToOne(optional=false) 
	@NotNull
	@JoinColumn(name="vendor_id", nullable=false) 
	private Vendor vendor;
	
	@NotNull
	@ManyToOne(optional=false)
	@JoinColumn(name="category_id", nullable=false)
	private ItemCategory category;
	
	@Column(name="created_on")
	private LocalDateTime createdOn;
	
	@PrePersist
	protected void onCreate() {
	    this.createdOn = LocalDateTime.now();
	}
	
	@NotNull
	@Column(name="item_name")
	private String itemName;
	
	@NotNull
	@Column(name="item_uom")
	private String itemUom;
	
	@NotNull
	@Min(value=0, message="Quantity must be non-negative")
	@Column(name="item_quantity")
	private Integer itemQuantity;
	
	@NotBlank
	@Column(name="item_batch_number")
	private String itemBatchNumber;
	
	@NotNull
	@Column(name="item_description")
	private String itemDescription;
	
	
	/* linkage to client facing products. */
	@OneToMany(mappedBy="inventoryItem", cascade=CascadeType.ALL, orphanRemoval=true)
	List<Product> products = new ArrayList<>();
	
	/* helper method for products collection */
	public void addProduct(Product product) {
		if (!products.contains(product)){
		    products.add(product);
		    product.setInventoryItem(this);
		}
	}

	
	public void removeProduct(Product product) { 
		products.remove(product); 
		product.setInventoryItem(null); 
	}
	
	/* Linkage to the stores */
	@OneToMany(mappedBy="item", cascade=CascadeType.ALL, orphanRemoval=true)
	private List<StoreItem> storeItems = new ArrayList<>();

	/* helper method for the storeitems */
	public void addStoreItem(StoreItem storeItem) { 
		if (!storeItems.contains(storeItem)){
			storeItems.add(storeItem); 
			storeItem.setItem(this); 
		}
	} 
	
	public void removeStoreItem(StoreItem storeItem) { 
		storeItems.remove(storeItem); 
		storeItem.setItem(null); 
	}
	
	/* Linkage to tags*/
	@ManyToMany 
	@JoinTable( name="item_tag_map", 
	joinColumns=@JoinColumn(name="item_id"), inverseJoinColumns=@JoinColumn(name="tag_id") ) 
	private List<ItemTag> tags = new ArrayList<>(); 
	
	/* helper methods for the tags collection */
	public void addTag(ItemTag tag) {
		if (!tags.contains(tag)){
			tags.add(tag);
			tag.getItems().add(this);
		}
	}
	
	public void removeTag(ItemTag tag) {
		tags.remove(tag);
		tag.getItems().remove(this);
	}
	
}
