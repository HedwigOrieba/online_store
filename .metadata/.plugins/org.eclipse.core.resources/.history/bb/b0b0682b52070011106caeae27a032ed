package com.bazotech.store.services;

import java.time.LocalDate;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import com.bazotech.store.domain.Merchant;
import com.bazotech.store.domain.Vendor;
import com.bazotech.store.domain.VendorMerchantAssociation;
import com.bazotech.store.repositories.MerchantRepository;
import com.bazotech.store.repositories.VendorMerchantRepository;
import com.bazotech.store.repositories.VendorRepository;

import jakarta.transaction.Transactional;
import lombok.AllArgsConstructor;

@AllArgsConstructor
@Service
public class VendorMerchantService {
	
	private static final Logger logger = LoggerFactory.getLogger(VendorMerchantService.class);
	private final VendorRepository vendorRepository;
	private final MerchantRepository merchantRepository;
	private final VendorMerchantRepository vendorMerchantRepository;
	
	@Transactional
	public void linkVendorToMerchant(Long vendorId, Long merchantId) {
		
		Vendor vendor = vendorRepository.findById(vendorId).orElseThrow(() -> new RuntimeException("Vendor not found with id: " + vendorId));
		Merchant merchant = merchantRepository.findById(merchantId).orElseThrow(() -> new RuntimeException("Merchant not found with id: " + merchantId));
		
		VendorMerchantAssociation association = VendorMerchantAssociation.builder()
				.vendor(vendor)
				.merchant(merchant)
				.contractDate(LocalDate.now())
				.created_on(LocalDate.now())
				.status(VendorMerchantAssociation.ActivityStatus.PENDING)
				.description("Contract between " + vendor.getVendorName() + " and " + merchant.getMerchantName())
				.build();
		
		vendor.addAssociation(association);
		merchant.addAssociation(association);
		
		vendorMerchantRepository.save(association);
		
		logger.info("Linked Vendor '{}' to Merchant '{}'", vendor.getVendorName(), merchant.getMerchantName());
	}
}
