package com.bazotech.store.jdbcrepositories;

import java.sql.Types;
import java.util.Arrays;
import java.util.Date;
import java.util.List;

import org.springframework.jdbc.core.JdbcOperations;
import org.springframework.jdbc.core.PreparedStatementCreator;
import org.springframework.jdbc.core.PreparedStatementCreatorFactory;
import org.springframework.jdbc.support.GeneratedKeyHolder;

import com.bazotech.store.domain.Taco;
import com.bazotech.store.domain.TacoOrder;

public class JdbcOrderRepository implements OrderRepository{
	
	private JdbcOperations jdbcOperations;
	
	public JdbcOrderRepository(JdbcOperations jdbcOperations) {
		this.jdbcOperations = jdbcOperations;
	}
	
	@Override
	public TacoOrder save(TacoOrder order) {
		
		PreparedStatementCreatorFactory pscf = new PreparedStatementCreatorFactory(
		 "insert into Taco_Order "
		 + "(delivery_name, delivery_street, delivery_city, delivery_state, delivery_zip, cc_number, cc_expiration, cc_cvv, placed_at) "
		 + "values (?, ?, ?, ?, ?, ?, ?, ?, ?)",
		 Types.VARCHAR, Types.VARCHAR, Types.VARCHAR, Types.VARCHAR, Types.VARCHAR, Types.VARCHAR, Types.VARCHAR, Types.VARCHAR, Types.TIMESTAMP
		);
		
		pscf.setReturnGeneratedKeys(true);
		
		order.setPlacedAt(new Date());
		
		PreparedStatementCreator psc = pscf.newPreparedStatementCreator(
				Arrays.asList(
				
					order.getDeliveryName(),
					order.getDeliveryStreet(),
					order.getDeliveryCity(),
					order.getDeliveryState(),
					order.getDeliveryZip(),
					order.getCreditCardNumber(),
					order.getCreditCardExpiration(),
					order.getCreditCardCVV(),
					order.getPlacedAt()
				));
			
		GeneratedKeyHolder keyHolder = new GeneratedKeyHolder();
		jdbcOperations.update(psc, keyHolder);
		long orderId = keyHolder.getKey().longValue();
		order.setId(orderId);
		
		List<Taco> tacos = order.getTacos();
		int i=0;
		for(Taco taco : tacos) {
			saveTaco(taco, orderId, i++);
		}
		
		return order;
		
	}

}
