package com.bazotech.store.domain;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import jakarta.persistence.CascadeType;
import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToMany;
import jakarta.persistence.PrePersist;
import jakarta.persistence.Table;
import jakarta.persistence.UniqueConstraint;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotNull;
import lombok.Builder;
import lombok.EqualsAndHashCode;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;

@Builder
@Setter
@Getter
@Entity
@ToString(exclude = {"inventoryItem","storeItems"}) 
@EqualsAndHashCode(onlyExplicitlyIncluded = true)
@Table( name = "item_batches", uniqueConstraints = { @UniqueConstraint(name = "unique_batch_per_item", columnNames = {"item_id", "batch_number"}) } )
public class ItemBatch {
	@Id 
	@GeneratedValue(strategy = GenerationType.IDENTITY) 
	@EqualsAndHashCode.Include
	@Column(name = "batch_id") 
	private Long batchId;
	
	@ManyToOne(fetch = FetchType.LAZY) 
	@JoinColumn(name = "item_id", nullable = false) 
	private InventoryItem inventoryItem;
	
	@Column(name = "batch_number", nullable = false) 
	private String batchNumber;
	
	@Column(name = "manufactured_on", nullable = false) 
	private LocalDateTime manufacturedOn;
	
	@PrePersist /* invoked before persiting an entity to the database. */
	protected void onCreate() { 
		if (manufacturedOn == null) { 
			manufacturedOn = LocalDateTime.now();
		}
	}
	
	@Column(name = "expires_on") 
	private LocalDateTime expiresOn;
	
	@NotNull
	@Builder.Default
	@Min(value = 0, message = "Batch quantity must be non-negative") 
	@Column(name = "batch_quantity", nullable = false) 
	private Integer batchQuantity = 0;
	
	// Relationship with StoreItems (one batch can appear in many stores) 
	@Builder.Default
	@OneToMany(mappedBy = "itemBatch", cascade = CascadeType.ALL, orphanRemoval = true) 
	private List<StoreItem> storeItems = new ArrayList<>();
	
	/* Helper methods to add & remove items from the storeitems list. */
	public void addStoreItem(StoreItem storeItem) {
	    if (!storeItems.contains(storeItem)) {
	        storeItems.add(storeItem);
	        storeItem.setItemBatch(this);
	    }
	}

	public void removeStoreItem(StoreItem storeItem) {
	    storeItems.remove(storeItem);
	    storeItem.setItemBatch(null);
	}

}
